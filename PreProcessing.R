####
# | 2020-05-09 |
# PROCESSOS TRANSFORMACAO URBBANA
# GET DATA AND PRE-PROCESSING  ----
####

####
# 0. LIBRARIES ----
####

library("tidyverse")
library("sf")


####
# 0. DIRECTORIES ----
####

#PC UA
pathUA = "C:/Users/pauloricardolb/Universidade de Aveiro/OP_DRIVIT-UP - Documentos/"

path = pathUA


setwd(paste(path, "02_RECURSOS/023_DSS_COMPONENTES/024_DEMOG_ECON/0241_PadroesTransfUrbana_JAN/MODELACAO/TransfUrb/PreProcessing", sep=""))


sourceTABLE_demografia = paste(path, "02_RECURSOS/020_DADOSGERAIS/TABELAS/DEMOGRAFIA/POPULACAO_GE5anos_CENSOS_91_01_11/", sep="")
sourceSIG_GEODATA_VARIOS_gdb = paste(path, "02_RECURSOS/020_DADOSGERAIS/SIG/GEODATA_VARIOS.gdb", sep = "")

#sourceTABLE_demografia = paste(path, " ", sep="")

sourceSIG_COS_gdb = paste(path, "02_RECURSOS/020_DADOSGERAIS/SIG/COS/COS.gdb", sep = "")





FREG18_DistMatrix = read_sf(dsn = sourceSIG_GEODATA_VARIOS_gdb, layer = "FREG18DISTMATRIX")

#COS2015withCAOP2018.shp = read_sf(dsn = sourceSIG_COS_gdb, layer = "COS2015withCAOP2018")



####
# 1. DEMOGRAFIA ----
####

####
# INE POP CENSOS 1991 - 2001 - 2011  ----
####



CENSOS1991_POP = read_delim(file = paste(sourceTABLE_demografia, "CENSOS1991_POPULACAO.txt",sep=""), col_names = TRUE, delim = "\t", 
                            col_types = cols(
                              NUTS1 = col_character(),
                              NUTS2 = col_character(),
                              NUTS3 = col_character(),
                              CONCELHO = col_character(),
                              FREGUESIA = col_character(),
                              SECCAO = col_character(),
                              SUBSEC = col_character()
                                             ) )


CENSOS1991_POP = subset(CENSOS1991_POP, SEXO_DSG == "HM")

CENSOS1991_POP$C91_GETotal = CENSOS1991_POP$'Total '
CENSOS1991_POP$C91_GEate20 = CENSOS1991_POP$GE_0_4 + CENSOS1991_POP$GE_5_9 + CENSOS1991_POP$GE_10_14 + CENSOS1991_POP$GE_15_19
CENSOS1991_POP$C91_GE2065 = CENSOS1991_POP$GE_20_24 + CENSOS1991_POP$GE_25_29 + CENSOS1991_POP$GE_30_34 + CENSOS1991_POP$GE_35_39 +
  CENSOS1991_POP$GE_40_44 + CENSOS1991_POP$GE_45_49 + CENSOS1991_POP$GE_50_54 + CENSOS1991_POP$GE_55_59 + CENSOS1991_POP$GE_60_64
CENSOS1991_POP$C91_GEmais65 = CENSOS1991_POP$GE_65_69 + CENSOS1991_POP$GE_70_74 + CENSOS1991_POP$GE_75_79 + CENSOS1991_POP$GE_80_84 +
  CENSOS1991_POP$GE_85_89 + CENSOS1991_POP$GE_90_94 + CENSOS1991_POP$GE_95_99 + CENSOS1991_POP$GE_100e 


CENSOS2001_POP = read_delim(file = paste(sourceTABLE_demografia, "CENSOS2001_POPULACAO.txt",sep=""), col_names = TRUE, delim = "\t" 
                            , col_types = cols(
                              NUTS1_EU02 = col_character(),
                              NUTS2_EU02 = col_character(),
                              NUTS3_EU02 = col_character(),
                              CONCELHO_EU02 = col_character(),
                              FREGUESIA_EU02 = col_character(),
                              SECCAO_EU02 = col_character(),
                              SUBSEC_EU02 = col_character()
                            )
                            )

CENSOS2001_POP = subset(CENSOS2001_POP, SEXO == "HM")


CENSOS2001_POP$C01_GETotal = CENSOS2001_POP$Total
CENSOS2001_POP$C01_GEate20 = CENSOS2001_POP$GE_0_4 + CENSOS2001_POP$GE_5_9 + CENSOS2001_POP$GE_10_14 + CENSOS2001_POP$GE_15_19
CENSOS2001_POP$C01_GE2065 = CENSOS2001_POP$GE_20_24 + CENSOS2001_POP$GE_25_29 + CENSOS2001_POP$GE_30_34 + CENSOS2001_POP$GE_35_39 +
  CENSOS2001_POP$GE_40_44 + CENSOS2001_POP$GE_45_49 + CENSOS2001_POP$GE_50_54 + CENSOS2001_POP$GE_55_59 + CENSOS2001_POP$GE_60_64
CENSOS2001_POP$C01_GEmais65 = CENSOS2001_POP$GE_65_69 + CENSOS2001_POP$GE_70_74 + CENSOS2001_POP$GE_75_79 + CENSOS2001_POP$GE_80_84 +
  CENSOS2001_POP$GE_85_89 + CENSOS2001_POP$GE_90_94 + CENSOS2001_POP$GE_95_99 + CENSOS2001_POP$GE_100e



CENSOS2011_POP = read_delim(file = paste(sourceTABLE_demografia, "CENSOS2011_POPULACAO.txt",sep=""), col_names = TRUE, delim = "\t"
                            , col_types = cols(
                              NUTS1 = col_character(),
                              NUTS2 = col_character(),
                              NUTS3 = col_character(),
                              MUNICIPIO = col_character(),
                              FREGUESIA = col_character(),
                              SECCAO = col_character(),
                              SUBSECCAO = col_character()
                            )
                            )

CENSOS2011_POP = subset(CENSOS2011_POP, SEXO == "HM")

CENSOS2011_POP$C11_GETotal = CENSOS2011_POP$'Total '
CENSOS2011_POP$C11_GEate20 = CENSOS2011_POP$GE_0_4 + CENSOS2011_POP$GE_5_9 + CENSOS2011_POP$GE_10_14 + CENSOS2011_POP$GE_15_19
CENSOS2011_POP$C11_GE2065 = CENSOS2011_POP$GE_20_24 + CENSOS2011_POP$GE_25_29 + CENSOS2011_POP$GE_30_34 + CENSOS2011_POP$GE_35_39 +
  CENSOS2011_POP$GE_40_44 + CENSOS2011_POP$GE_45_49 + CENSOS2011_POP$GE_50_54 + CENSOS2011_POP$GE_55_59 + CENSOS2011_POP$GE_60_64
CENSOS2011_POP$C11_GEmais65 = CENSOS2011_POP$GE_65_69 + CENSOS2011_POP$GE_70_74 + CENSOS2011_POP$GE_75_79 + CENSOS2011_POP$GE_80_84 +
  CENSOS2011_POP$GE_85_89 + CENSOS2011_POP$GE_90_94 + CENSOS2011_POP$GE_95_99 + CENSOS2011_POP$GE_100e 



####
# GEODATA_910111 ----
####

UNION_SUBSECtoNUTSIII.shp = read_sf(dsn = sourceSIG_GEODATA_VARIOS_gdb, layer = "UNION_SUBSECtoNUTSIII_2018_LxCorrigido")

UNION_SUBSECtoNUTSIII = tbl_df(UNION_SUBSECtoNUTSIII.shp)

GEODATA_910111 = UNION_SUBSECtoNUTSIII
GEODATA_910111$PONDSUBSEC1191 = GEODATA_910111$AREA_UNION_PART / GEODATA_910111$AREASUBSEC91
GEODATA_910111$PONDSUBSEC1101 = GEODATA_910111$AREA_UNION_PART / GEODATA_910111$AREASUBSEC01
GEODATA_910111$PONDSUBSEC1111 = GEODATA_910111$AREA_UNION_PART / GEODATA_910111$AREASUBSEC11
GEODATA_910111$PONDAREAFREG18 = GEODATA_910111$AREA_UNION_PART / GEODATA_910111$AREAFREG18


####
# GEODATA&INE_POP_910111  ----
####

GEODATA_910111_POP = GEODATA_910111

GEODATA_910111_POP = left_join(GEODATA_910111_POP, CENSOS1991_POP[,c("SUBSEC","C91_GETotal", "C91_GEate20", "C91_GE2065", "C91_GEmais65")], by = c("BGRE1991" = "SUBSEC"))

GEODATA_910111_POP$C91_PopPOND_Total = GEODATA_910111_POP$C91_GETotal * GEODATA_910111_POP$PONDSUBSEC1191
GEODATA_910111_POP$C91_PopPOND_GEate20 = GEODATA_910111_POP$C91_GEate20 * GEODATA_910111_POP$PONDSUBSEC1191
GEODATA_910111_POP$C91_PopPOND_GE2065 = GEODATA_910111_POP$C91_GE2065 * GEODATA_910111_POP$PONDSUBSEC1191
GEODATA_910111_POP$C91_PopPOND_GEmais65 = GEODATA_910111_POP$C91_GEmais65 * GEODATA_910111_POP$PONDSUBSEC1191

GEODATA_910111_POP = left_join(GEODATA_910111_POP, CENSOS2001_POP[,c("SUBSEC_EU02","C01_GETotal", "C01_GEate20", "C01_GE2065", "C01_GEmais65")], by = c("BGRI2001" = "SUBSEC_EU02"))

GEODATA_910111_POP$C01_PopPOND_Total = GEODATA_910111_POP$C01_GETotal * GEODATA_910111_POP$PONDSUBSEC1101
GEODATA_910111_POP$C01_PopPOND_GEate20 = GEODATA_910111_POP$C01_GEate20 * GEODATA_910111_POP$PONDSUBSEC1101
GEODATA_910111_POP$C01_PopPOND_GE2065 = GEODATA_910111_POP$C01_GE2065 * GEODATA_910111_POP$PONDSUBSEC1101
GEODATA_910111_POP$C01_PopPOND_GEmais65 = GEODATA_910111_POP$C01_GEmais65 * GEODATA_910111_POP$PONDSUBSEC1101

GEODATA_910111_POP = left_join(GEODATA_910111_POP, CENSOS2011_POP[,c("SUBSECCAO","C11_GETotal", "C11_GEate20", "C11_GE2065", "C11_GEmais65")], by = c("BGRI11" = "SUBSECCAO"))

GEODATA_910111_POP$C11_PopPOND_Total = GEODATA_910111_POP$C11_GETotal * GEODATA_910111_POP$PONDSUBSEC1111
GEODATA_910111_POP$C11_PopPOND_GEate20 = GEODATA_910111_POP$C11_GEate20 * GEODATA_910111_POP$PONDSUBSEC1111
GEODATA_910111_POP$C11_PopPOND_GE2065 = GEODATA_910111_POP$C11_GE2065 * GEODATA_910111_POP$PONDSUBSEC1111
GEODATA_910111_POP$C11_PopPOND_GEmais65 = GEODATA_910111_POP$C11_GEmais65 * GEODATA_910111_POP$PONDSUBSEC1111


OUT.POPCENSOS_2001e2011 = GEODATA_910111_POP %>% 
  group_by( DICOFRE18, FREG18_la ) %>% 
  summarise(
    
    POP2011 = round(sum(C11_PopPOND_Total,  na.rm = TRUE),0),
    POP2001 = round(sum(C01_PopPOND_Total,  na.rm = TRUE),0),
    DensPOP2011 = round(POP2011 / sum(AREA_UNION_PART*10^-6,  na.rm = TRUE),2),
    VarPOP0111 = round((POP2011 - POP2001) / POP2001 , 2)
    
    )





